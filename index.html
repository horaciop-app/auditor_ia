<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTIZA CISO AI OFFICER v4.4 (Model Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LIBRERÍAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuración del Worker de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .step-active { border-color: #059669; color: #059669; } 
        .step-inactive { border-color: #e5e7eb; color: #9ca3af; }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #059669;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { bg: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { bg: #cbd5e1; border-radius: 3px; }
        
        #globalError { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; padding: 10px; z-index: 9999; text-align: center; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <div id="globalError"></div>
    <script>
        window.onerror = function(msg, url, line) {
            const div = document.getElementById('globalError');
            div.style.display = 'block';
            div.innerText = `Error JS Detectado: ${msg} (Línea ${line})`;
        };
    </script>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-user-shield text-emerald-400"></i> INTIZA CISO AI OFFICER
            </h1>
            <div class="flex items-center gap-3">
                <div class="text-xs text-right hidden sm:block">
                    <div class="font-bold text-emerald-400">MODO CORPORATIVO</div>
                    <div class="text-slate-400 text-[10px]">v4.4</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Token Meter -->
        <div class="mb-4 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
            <div class="flex justify-between items-end mb-2">
                <label class="text-xs font-bold text-slate-600 uppercase tracking-wider flex items-center gap-1">
                    <i class="fas fa-memory text-purple-500"></i> Uso de Memoria (Contexto)
                </label>
                <span id="tokenCountDisplay" class="text-xs font-mono font-semibold text-slate-600">0 / 1,000,000 Tokens</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                <div id="tokenProgressBar" class="bg-purple-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-[10px] text-slate-400 mt-1 text-right">Estimado basado en el texto cargado (1M límite)</p>
        </div>

        <!-- API Key -->
        <div id="apiKeySection" class="mb-8 bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-emerald-500">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-bold text-slate-700">Configuración de IA</label>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center gap-1"><i class="fas fa-key"></i> Tu API Key</a>
            </div>
            <input type="password" id="apiKeyInput" placeholder="Pega tu Gemini API Key aquí..." class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-sm">
        </div>

        <!-- Progress Steps -->
        <div class="flex justify-between mb-8 text-sm font-medium select-none">
            <div id="step1-ind" class="flex flex-col items-center step-active w-1/3 cursor-pointer transition-all" onclick="showStep(1)">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center mb-1 bg-white">1</div>
                <span>Fuentes</span>
            </div>
            <div id="step2-ind" class="flex flex-col items-center step-inactive w-1/3 cursor-pointer transition-all" onclick="showStep(2)">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center mb-1 bg-white">2</div>
                <span>Cuestionario</span>
            </div>
            <div id="step3-ind" class="flex flex-col items-center step-inactive w-1/3 cursor-pointer transition-all" onclick="showStep(3)">
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center mb-1 bg-white">3</div>
                <span>Análisis</span>
            </div>
        </div>

        <!-- STEP 1: Knowledge Base -->
        <div id="step1" class="step-content bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                    1. Base de Conocimiento Central
                    <span id="serverStatusBadge" class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded border">Estado: Local</span>
                </h2>
                <div class="flex gap-2">
                    <button onclick="window.debugSync()" class="text-xs bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded transition font-bold shadow-md flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i> SINCRONIZAR
                    </button>
                    <button onclick="window.clearDB('documents')" class="text-xs text-red-400 hover:text-red-600 px-2 py-1 transition" title="Borrar todo">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div id="syncArea" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
                <div class="flex items-start gap-3">
                    <div class="loader" id="syncLoader"></div>
                    <div class="flex-1">
                        <h4 class="text-sm font-bold text-slate-700" id="syncTitle">Sincronizando...</h4>
                        <div class="text-xs text-slate-500 font-mono mt-2 p-2 bg-white border rounded h-32 overflow-y-auto" id="syncLog"></div>
                    </div>
                </div>
            </div>

            <div id="filesListContainer" class="bg-white rounded-lg border border-slate-200 p-0 overflow-hidden mb-4">
                <div class="bg-slate-100 px-4 py-2 text-xs font-bold text-slate-500 flex justify-between">
                    <span>DOCUMENTOS ACTIVOS</span>
                    <span id="storageSize">0 Docs</span>
                </div>
                <ul id="uploadedFilesList" class="divide-y divide-slate-100 max-h-60 overflow-y-auto scrollbar-thin">
                    <li class="p-4 text-center text-slate-400 text-sm italic">No hay documentos cargados.</li>
                </ul>
            </div>
            
            <div class="mt-4 pt-4 border-t border-slate-100">
                <details>
                    <summary class="text-xs text-slate-500 cursor-pointer hover:text-blue-600 font-medium">Opciones: Subir archivo local manualmente</summary>
                    <div class="mt-2 border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 relative">
                        <input type="file" id="sourcePdf" accept="application/pdf" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleSourceUpload()">
                        <span class="text-xs text-slate-500"><i class="fas fa-upload"></i> Arrastra PDF extra aquí</span>
                    </div>
                    <p class="text-[10px] text-amber-700 mt-2 bg-amber-50 p-2 rounded border border-amber-100 flex items-start gap-2">
                        <i class="fas fa-lightbulb mt-0.5 text-amber-500"></i> 
                        <span><strong>TIP:</strong> Para una mejor lectura del archivo trate de no dejar espacios en blanco en el nombre del mismo, coloque en su lugar un guion medio (-) o un guion bajo (_)</span>
                    </p>
                </details>
            </div>

            <div id="sourceProcessing" class="hidden mt-4 flex items-center justify-center text-blue-600 gap-2">
                <div class="loader"></div> <span id="procText">Procesando...</span>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="btnToStep2" onclick="goToStep2()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium opacity-50 cursor-not-allowed shadow-md transition-all" disabled>
                    Siguiente <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- STEP 2: Questions Setup (Hybrid) -->
        <div id="step2" class="hidden step-content bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-800">2. Cargar Preguntas</h2>
                <button onclick="window.clearDB('questions')" class="text-xs text-orange-500 hover:bg-orange-50 border border-orange-200 px-2 py-1 rounded transition"><i class="fas fa-eraser"></i> Limpiar</button>
            </div>
            
            <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:bg-slate-50 transition-colors cursor-pointer relative group">
                <input type="file" id="questionFiles" multiple accept=".pdf,.docx,.xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="checkStep2Readiness()">
                <div class="flex flex-col items-center pointer-events-none">
                    <div class="flex gap-4 mb-3 text-slate-400">
                        <i class="fas fa-file-pdf text-3xl group-hover:text-red-500"></i>
                        <i class="fas fa-file-excel text-3xl group-hover:text-green-600"></i>
                        <i class="fas fa-file-word text-3xl group-hover:text-blue-600"></i>
                    </div>
                    <span class="text-slate-600 font-medium">Arrastra tus archivos de Cuestionario aquí</span>
                </div>
            </div>
            <div id="selectedQuestionsFiles" class="mt-2 text-xs text-slate-500 font-mono hidden text-center"></div>
            
            <div class="mt-6 relative">
                <div class="absolute top-0 left-0 -mt-3 ml-3 bg-white px-2 text-xs font-bold text-slate-400">O PEGAR PREGUNTAS (TEXTO PLANO)</div>
                <textarea id="manualQuestionText" 
                    class="w-full border border-slate-300 rounded-lg p-3 text-sm text-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none resize-none scrollbar-thin" 
                    rows="5" 
                    placeholder="Pega aquí una o varias preguntas si no tienes un archivo... (Soporta múltiples líneas)"
                    oninput="checkStep2Readiness()"></textarea>
                <div class="text-[10px] text-slate-400 text-right mt-1">Máx visible ~100 palabras (scrolleable)</div>
            </div>

            <div id="questionsListArea" class="hidden mt-6">
                <h3 class="text-md font-bold text-slate-700 mb-2 flex justify-between items-center">
                    Alcance <span id="qCount" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
                </h3>
                <div id="questionsList" class="bg-slate-50 p-4 rounded border border-slate-200 max-h-60 overflow-y-auto space-y-2 text-sm scrollbar-thin"></div>
            </div>
            <div id="extractingLoader" class="hidden mt-4 flex items-center justify-center text-blue-600 gap-2"><div class="loader"></div> Analizando...</div>

            <div class="mt-6 flex justify-between">
                <button onclick="showStep(1)" class="text-slate-500 hover:text-slate-700 font-medium px-4 py-2">Atrás</button>
                <button id="btnAnalyze" onclick="extractQuestions()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-lg font-medium hidden shadow">Analizar Contenido</button>
                <button id="btnToStep3" onclick="startQueueProcessing()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium hidden shadow-lg transform hover:-translate-y-1 transition-all">Comenzar Análisis <i class="fas fa-play ml-1"></i></button>
            </div>
        </div>

        <!-- STEP 3: Results -->
        <div id="step3" class="hidden step-content bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4 bg-slate-50 p-3 rounded border border-slate-100 sticky top-0 z-10">
                <div>
                    <h2 class="text-lg font-semibold text-slate-800">3. Informe CISO</h2>
                    <div class="text-xs text-slate-500" id="progressStats">Listo</div>
                </div>
                <div class="flex gap-2">
                     <button id="btnStop" onclick="stopProcessing()" class="hidden text-xs bg-red-100 text-red-600 border border-red-200 px-3 py-1 rounded font-bold hover:bg-red-200"><i class="fas fa-stop"></i> PAUSAR</button>
                     <button id="btnResume" onclick="startQueueProcessing()" class="hidden text-xs bg-green-100 text-green-700 border border-green-200 px-3 py-1 rounded font-bold hover:bg-green-200"><i class="fas fa-play"></i> REANUDAR</button>
                </div>
            </div>
            <div class="flex gap-2 mb-6 flex-wrap">
                 <button onclick="copyAllResults()" class="text-xs bg-white border shadow-sm px-3 py-1 rounded hover:bg-slate-50"><i class="fas fa-copy"></i> Copiar</button>
                 <button onclick="window.print()" class="text-xs bg-white border shadow-sm px-3 py-1 rounded hover:bg-slate-50"><i class="fas fa-print"></i> Imprimir</button>
                 <button onclick="sendEmail()" class="text-xs bg-blue-50 border border-blue-200 text-blue-700 px-3 py-1 rounded font-semibold"><i class="fas fa-envelope"></i> Email</button>
            </div>
            <div id="resultsContainer" class="space-y-6 pb-20 min-h-[300px]"></div>
            <div class="mt-6 flex justify-start"><button onclick="showStep(2)" class="text-slate-500 hover:text-slate-700 font-medium px-4 py-2">Atrás</button></div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-slate-100 p-6 text-center border-t border-slate-200 mt-8">
        <p class="text-slate-700 font-semibold text-sm mb-1">
            Gracias por utilizar nuestro sistema de respuestas SGSI, recuerde que siempre debe validarlas con un analista de Seguridad.
        </p>
        <p class="text-slate-500 text-xs">
            Las mismas se basan en nuestro Marco Normativo y Certificación ISO 27001:2022
        </p>
    </footer>

    <script>
        // --- UTILS & CONFIG ---
        const GEMINI_MODEL = "gemini-1.5-flash-001"; // VERSIÓN ESTABLE 001
        const API_DELAY_MS = 4000; 

        function log(msg, type='info') {
            const box = document.getElementById('syncLog');
            if(!box) return;
            const d = document.createElement('div');
            d.textContent = `> ${msg}`;
            if(type==='error') d.style.color = '#ef4444';
            else if(type==='success') d.style.color = '#10b981';
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${msg}`);
        }
        function getEl(id) { return document.getElementById(id); }
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        // --- DATABASE ---
        const DB_NAME = 'AuditorDB_v3'; 
        const STORE_DOCS = 'documents'; 
        const STORE_QUESTIONS = 'questions'; 
        
        const dbPromise = new Promise((res, rej) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_DOCS)) db.createObjectStore(STORE_DOCS, { keyPath: 'name' });
                if (!db.objectStoreNames.contains(STORE_QUESTIONS)) db.createObjectStore(STORE_QUESTIONS, { keyPath: 'id' });
            };
            req.onsuccess = (e) => res(e.target.result);
            req.onerror = (e) => rej(e.target.error);
        });

        async function dbOp(mode, store, cb) {
            const db = await dbPromise;
            return new Promise((res, rej) => {
                const tx = db.transaction(store, mode);
                const req = cb(tx.objectStore(store));
                tx.oncomplete = () => res(req?.result);
                tx.onerror = () => rej(tx.error);
                if (req && req.onsuccess === null) req.onsuccess = ()=>{};
            });
        }

        // Global DB Functions
        window.saveDoc = async function(name, content, source='local') { await dbOp('readwrite', STORE_DOCS, s => s.put({name, content, source})); };
        window.loadDocs = async function() { return new Promise(async res => { (await dbPromise).transaction(STORE_DOCS).objectStore(STORE_DOCS).getAll().onsuccess = e => res(e.target.result); }); };
        window.saveQ = async function(q) { await dbOp('readwrite', STORE_QUESTIONS, s => s.put(q)); };
        window.loadQs = async function() { return new Promise(async res => { (await dbPromise).transaction(STORE_QUESTIONS).objectStore(STORE_QUESTIONS).getAll().onsuccess = e => res(e.target.result); }); };
        window.clearDB = async function(store) { if(confirm("¿Borrar datos?")) { await dbOp('readwrite', store, s => s.clear()); window.location.reload(); } };

        // --- STATE ---
        let state = { apiKey: localStorage.getItem('ciso_key')||'', sourceText:'', questions:[], abort:null, processing:false };

        // --- INIT ---
        window.onload = async function() {
            if(state.apiKey) getEl('apiKeyInput').value = state.apiKey;
            await refreshDocsUI();
            
            const qs = await window.loadQs();
            if(qs.length > 0) {
                state.questions = qs.sort((a,b) => a.id.localeCompare(b.id, undefined, {numeric: true}));
                updateQuestionsUI(); renderResultsUI(); enableStep(3);
                const pending = state.questions.filter(q => q.status === 'pending');
                if(pending.length > 0) getEl('btnResume').classList.remove('hidden');
            }
            
            if(window.location.protocol === 'file:') {
                 log("ERROR: Modo local file:// detectado. La sincronización no funcionará.", 'error');
            }
        };

        // --- SYNC FUNCTION ---
        window.debugSync = async function() {
            const loader = getEl('syncLoader');
            const area = getEl('syncArea');
            const title = getEl('syncTitle');
            const logBox = getEl('syncLog');
            
            area.classList.remove('hidden');
            loader.classList.remove('hidden');
            logBox.innerHTML = ''; 
            title.textContent = "Sincronizando...";
            log("Iniciando proceso...");

            if (window.location.protocol === 'file:') {
                log("ERROR FATAL: Protocolo file:// no soportado.", 'error');
                loader.classList.add('hidden');
                return;
            }

            try {
                log("Leyendo manifest.json...");
                const manifestRes = await fetch('manifest.json?t=' + new Date().getTime());
                
                if(manifestRes.status === 404) throw new Error("No se encontró 'manifest.json'.");
                if(!manifestRes.ok) throw new Error(`Error HTTP ${manifestRes.status}`);
                
                let files;
                try { files = await manifestRes.json(); } catch(e) { throw new Error("JSON corrupto en manifest."); }
                
                if(!Array.isArray(files)) throw new Error("Formato inválido en manifest.");
                log(`Manifest OK. ${files.length} archivos.`, 'success');

                let count = 0;
                for(const fileName of files) {
                    log(`Bajando: ${fileName}...`);
                    const safeName = encodeURIComponent(fileName);
                    const fRes = await fetch(`fuentes/${safeName}`);
                    
                    if(!fRes.ok) {
                        log(`Error ${fRes.status} en ${fileName}`, 'error');
                        continue;
                    }

                    const blob = await fRes.blob();
                    log(`Procesando ${fileName}...`);
                    
                    let text = "";
                    const lowerName = fileName.toLowerCase();
                    if(lowerName.endsWith('.pdf')) text = await extractTextFromPDF(blob);
                    else if(lowerName.endsWith('.docx')) text = await extractTextFromDOCX(blob);
                    else text = await extractTextFromPDF(blob); 
                    
                    await window.saveDoc(fileName, text, 'server');
                    log(`OK: ${fileName}`, 'success');
                    count++;
                }

                log(`FIN. ${count} archivos guardados.`, 'success');
                await refreshDocsUI();
                setTimeout(() => area.classList.add('hidden'), 5000);

            } catch(e) {
                log(`ERROR CRÍTICO: ${e.message}`, 'error');
                alert("Error Sync: " + e.message);
            } finally {
                loader.classList.add('hidden');
            }
        };
        
        function updateTokenMeter() {
            const textLength = state.sourceText.length;
            const estimatedTokens = Math.ceil(textLength / 4); 
            const maxTokens = 1000000; 
            const percentage = Math.min((estimatedTokens / maxTokens) * 100, 100);
            
            const bar = document.getElementById('tokenProgressBar');
            const display = document.getElementById('tokenCountDisplay');
            
            if(bar && display) {
                bar.style.width = percentage + '%';
                if(percentage > 90) bar.className = "bg-red-500 h-2.5 rounded-full transition-all duration-500";
                else if(percentage > 70) bar.className = "bg-orange-500 h-2.5 rounded-full transition-all duration-500";
                else bar.className = "bg-purple-500 h-2.5 rounded-full transition-all duration-500";
                
                display.textContent = `${estimatedTokens.toLocaleString()} / ${maxTokens.toLocaleString()} Tokens`;
            }
        }

        async function refreshDocsUI() {
            const docs = await window.loadDocs();
            const list = getEl('uploadedFilesList');
            const badge = getEl('serverStatusBadge');
            
            if(docs.length > 0) {
                state.sourceText = docs.map(d => `\n=== DOC (${d.source}): ${d.name} ===\n${d.content}`).join('\n');
                getEl('storageSize').textContent = docs.length + " Docs";
                updateTokenMeter();
                
                list.innerHTML = '';
                docs.forEach(d => {
                    const color = d.source === 'server' ? 'text-purple-500' : 'text-green-500';
                    list.innerHTML += `<li class="p-2 text-sm border-b flex justify-between"><span class="${color} font-bold">${d.name}</span> <span class="text-xs text-gray-400 uppercase">${d.source}</span></li>`;
                });

                getEl('btnToStep2').disabled = false;
                getEl('btnToStep2').classList.remove('opacity-50', 'cursor-not-allowed');
                enableStep(2);
                
                const hasServer = docs.some(d => d.source === 'server');
                badge.textContent = hasServer ? "Conectado" : "Local";
                badge.className = hasServer ? "text-[10px] bg-purple-100 text-purple-600 px-2 py-1 rounded border font-bold" : "text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded border";
            } else {
                updateTokenMeter();
            }
        }

        // --- EXTRACTION ---
        async function extractTextFromPDF(blob) {
            const pdf = await pdfjsLib.getDocument({ data: await blob.arrayBuffer() }).promise;
            let t = ''; for(let i=1;i<=pdf.numPages;i++) t += `\n[Pág ${i}] ` + (await (await pdf.getPage(i)).getTextContent()).items.map(x=>x.str).join(' ');
            return t;
        }
        async function extractTextFromDOCX(blob) { return `\n[DOCX] ` + (await mammoth.extractRawText({arrayBuffer: await blob.arrayBuffer()})).value; }
        async function extractTextFromXLSX(blob) {
            const wb = XLSX.read(await blob.arrayBuffer());
            let t = `\n[XLSX]`; wb.SheetNames.forEach(n => { t+=`\nSheet: ${n}\n`+XLSX.utils.sheet_to_csv(wb.Sheets[n]); });
            return t;
        }

        // --- UI HANDLERS ---
        async function handleSourceUpload() { 
            const files = getEl('sourcePdf').files;
            getEl('sourceProcessing').classList.remove('hidden');
            for(const f of files) await window.saveDoc(f.name, await extractTextFromPDF(f), 'local');
            getEl('sourceProcessing').classList.add('hidden');
            await refreshDocsUI();
        }

        function goToStep2() {
            const k = getEl('apiKeyInput').value.trim();
            if(!k) return alert("Falta API Key");
            localStorage.setItem('ciso_key', k); state.apiKey = k; showStep(2);
        }

        window.checkStep2Readiness = function() {
            const files = getEl('questionFiles').files;
            const text = getEl('manualQuestionText').value.trim();
            
            if(files.length > 0) {
                getEl('selectedQuestionsFiles').textContent = Array.from(files).map(x=>x.name).join(', ');
                getEl('selectedQuestionsFiles').classList.remove('hidden');
            } else {
                getEl('selectedQuestionsFiles').classList.add('hidden');
            }

            if(files.length > 0 || text.length > 0) {
                getEl('btnAnalyze').classList.remove('hidden');
            } else {
                getEl('btnAnalyze').classList.add('hidden');
            }
        };

        async function extractQuestions() {
            const files = getEl('questionFiles').files;
            const manualText = getEl('manualQuestionText').value.trim();
            
            getEl('extractingLoader').classList.remove('hidden');
            getEl('btnAnalyze').classList.add('hidden');
            
            try {
                let txt = "";
                
                for(const f of files) {
                    const ext = f.name.split('.').pop().toLowerCase();
                    if(ext==='pdf') txt += await extractTextFromPDF(f);
                    else if(ext==='docx') txt += await extractTextFromDOCX(f);
                    else if(ext.startsWith('xls')) txt += await extractTextFromXLSX(f);
                }
                if(manualText) txt += `\n\n--- PREGUNTAS MANUALES ---\n${manualText}\n\n`;

                if(!txt.trim()) throw new Error("No se encontró texto para analizar.");

                const prompt = `ACTÚA COMO CISO. Analiza y extrae preguntas/controles en JSON: [{"id":"1","text":"Pregunta"}]. TEXTO: ${txt.substring(0,50000)}`;
                const res = await callGemini(prompt, true);
                
                const cleanJson = res.replace(new RegExp('```json|```', 'g'), '').trim();
                const qs = JSON.parse(cleanJson).map(q=>({...q, status:'pending', attempts:0}));
                
                await dbOp('readwrite', STORE_QUESTIONS, s => s.clear());
                for(const q of qs) await window.saveQ(q);
                state.questions = qs; updateQuestionsUI();
                
                getEl('extractingLoader').classList.add('hidden');
                getEl('questionsListArea').classList.remove('hidden');
                getEl('btnToStep3').classList.remove('hidden');
            } catch(e) { alert(e.message); console.error(e); getEl('extractingLoader').classList.add('hidden'); getEl('btnAnalyze').classList.remove('hidden'); }
        }

        function updateQuestionsUI() {
            getEl('qCount').textContent = state.questions.length;
            const l = getEl('questionsList'); l.innerHTML = '';
            state.questions.forEach(q => l.innerHTML+=`<div class="flex gap-2 text-xs p-1 border-b"><b class="text-emerald-600 min-w-[30px]">${q.id}</b> <span>${q.text}</span></div>`);
        }

        // --- EXECUTION ---
        async function startQueueProcessing() {
            showStep(3); state.processing=true; state.abort=new AbortController();
            getEl('btnStop').classList.remove('hidden');
            getEl('btnResume').classList.add('hidden');
            renderResultsUI();
            
            const pending = state.questions.filter(q => q.status==='pending'||q.status==='retry');
            for(const q of pending) {
                if(!state.processing) break;
                const card = getEl(`card-${q.id}`);
                if(card) {
                    card.scrollIntoView({behavior:'smooth',block:'center'});
                    card.classList.add('border-emerald-400','shadow-md');
                    card.querySelector('.status-ind').innerHTML=`<i class="fas fa-circle-notch fa-spin text-emerald-500"></i> Analizando (Espera ${API_DELAY_MS/1000}s)...`;
                }
                getEl('progressStats').textContent=`Analizando ID ${q.id}...`;
                
                await sleep(API_DELAY_MS); 

                try {
                    const prompt = `
                        ROL: Actúa como un CISO (Chief Information Security Officer) Senior y Auditor Experto.
                        OBJETIVO: Responder la pregunta del usuario basándose EXHAUSTIVAMENTE en la documentación provista.
                        
                        INSTRUCCIONES DE BÚSQUEDA:
                        1. NO te quedes con la primera coincidencia. Muchos temas se tocan de forma general en una "Política" pero se detallan en un "Procedimiento" o "Estándar".
                        2. Debes leer TODOS los documentos del contexto antes de formular la respuesta.
                        3. PRIORIZA la especificidad: Si un documento es más detallado o específico sobre el tema de la pregunta, ese tiene mayor peso que uno general.
                        4. SINTETIZA: Si varios documentos hablan del tema, combínalos para dar la respuesta más completa posible.
                        
                        FORMATO DE RESPUESTA:
                        - Respuesta directa y técnica en español.
                        - Cita explícitamente el/los nombre(s) del documento(s) y sección(es) de donde extrajiste la información.
                        
                        CONTEXTO (Fuentes): 
                        """${state.sourceText.substring(0, 1000000)}"""
                        
                        PREGUNTA: "${q.text}"
                    `;
                    
                    const ans = await callGemini(prompt, false, state.abort.signal);
                    q.status='done'; q.answer=ans; await window.saveQ(q); renderCard(card,q);
                } catch(e) {
                    if(e.name==='AbortError') break;
                    q.attempts++;
                    if(q.attempts<3) { q.status='retry'; if(card) card.querySelector('.status-ind').textContent=`Reintentando (${q.attempts})...`; }
                    else { q.status='error'; q.answer="Error: "+e.message; if(card) card.classList.add('border-red-500'); }
                    await window.saveQ(q);
                }
                if(card) card.classList.remove('border-emerald-400','shadow-md');
            }
            state.processing=false;
            getEl('btnStop').classList.add('hidden');
            getEl('progressStats').textContent = state.questions.some(q=>q.status==='pending') ? "Pausado" : "Completado";
            if(state.questions.some(q=>q.status==='pending')) getEl('btnResume').classList.remove('hidden');
        }

        function stopProcessing() { if(state.abort) state.abort.abort(); state.processing=false; }

        // --- RENDERING ---
        function renderResultsUI() {
            const c = getEl('resultsContainer'); c.innerHTML = '';
            state.questions.forEach(q => {
                const d = document.createElement('div');
                d.id = `card-${q.id}`; d.className = "bg-white p-4 rounded border border-slate-200 text-sm transition-all";
                d.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <div class="flex gap-2"><span class="font-bold bg-slate-100 px-2 rounded">${q.id}</span> <span class="status-ind text-xs text-slate-400">${getIcon(q.status)}</span></div>
                        <button onclick="toggleFb('${q.id}')" class="text-red-300 hover:text-red-500"><i class="fas fa-flag"></i></button>
                    </div>
                    <p class="font-medium mb-2">${q.text}</p>
                    <div class="ans-body text-slate-600 border-t pt-2 mt-2">${format(q.answer)}</div>
                    <div id="fb-${q.id}" class="hidden mt-2 bg-red-50 p-2 rounded"><textarea id="tx-${q.id}" class="w-full text-xs p-1 mb-1" placeholder="Corrección..."></textarea><button onclick="reproc('${q.id}')" class="bg-red-500 text-white text-xs px-2 py-1 rounded">Corregir</button></div>
                `;
                c.appendChild(d);
            });
        }
        function renderCard(c,q) { if(c) { c.querySelector('.status-ind').innerHTML=getIcon(q.status); c.querySelector('.ans-body').innerHTML=format(q.answer); } }
        function getIcon(s) { return s==='done'?'<i class="fas fa-check text-emerald-500"></i>':s==='error'?'<i class="fas fa-times text-red-500"></i>':s; }
        function toggleFb(id) { getEl(`fb-${id}`).classList.toggle('hidden'); }
        function format(t) { return t?t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>'):'<i class="text-slate-300">Pendiente...</i>'; }

        // --- API & REPROC ---
        window.reproc = async function(id) {
            const fb = getEl(`tx-${id}`).value; const q = state.questions.find(x=>x.id===id);
            getEl(`fb-${id}`).classList.add('hidden');
            const c = getEl(`card-${id}`); c.querySelector('.ans-body').innerHTML='<i class="fas fa-spin fa-sync"></i>';
            
            const p = `ROL: CISO Senior. TAREA: Corregir respuesta anterior. PREGUNTA: "${q.text}" ERROR REPORTADO: "${fb}". INSTRUCCIÓN: Revisa exhaustivamente TODAS las fuentes nuevamente. FUENTES: ${state.sourceText.substring(0,1000000)}`;
            
            await sleep(API_DELAY_MS); 
            
            q.answer = await callGemini(p, false); q.status='done'; await window.saveQ(q); renderCard(c,q);
        };

        async function askGemini(q, ctx, sig) {
            const p = `Rol: CISO Senior. Responde en Español. Contexto: """${ctx.substring(0,100000)}""". Pregunta: "${q}". Responde solo con evidencia del contexto. Sé directivo y técnico.`;
            return await callGemini(p, false, sig);
        }

        async function callGemini(text, json, signal) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${state.apiKey}`;
            const body = { contents:[{parts:[{text}]}] }; if(json) body.generationConfig={responseMimeType:"application/json"};
            const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body), signal });
            if(!r.ok) throw new Error((await r.json()).error?.message);
            return (await r.json()).candidates[0].content.parts[0].text;
        }

        // --- NAV ---
        window.showStep = function(n) {
            [1,2,3].forEach(i=>{ getEl(`step${i}`).classList.add('hidden'); getEl(`step${i}-ind`).className=`flex flex-col items-center w-1/3 cursor-pointer ${i===n?'step-active font-bold':'step-inactive'}`; });
            getEl(`step${n}`).classList.remove('hidden');
        };
        function enableStep(n) { getEl(`step${n}-ind`).classList.remove('step-inactive'); }
        window.copyAllResults = function() { navigator.clipboard.writeText(getEl('resultsContainer').innerText); alert("Copiado"); };
        window.sendEmail = function() { window.location.href=`mailto:?subject=Reporte CISO&body=${encodeURIComponent(getEl('resultsContainer').innerText.substring(0,1800))}`; };
    </script>
</body>
</html>